# `ntransporter/cross_sections/`

Directory for all things involving reading in cross section 
data from Geant4, storing and plotting cross section data, 
and calculating group constants

## Executables

This directory generates two executables for group cross section evaluation, `NT_XS` and `NT_XX`.

### `NT_XS`

`NT_XS` is the primary executable generated by the `cross_sections` directory. It calculates group cross sections for a single combination of material, number of fast groups, and number of points in numerical evaluation. The call signature is:

```
./NT_XS output_file_base_path material [ngroups=100] [points_per_group=10]
```

**Outputs:**

The executable creates one output data file, with the form 

```
<output_file_base_path>_<material>_<ngroups>_<points_per_group>_xs.dat
```

This file contains evaluated group cross section data in four columns. Each row looks like:

$g\hspace{5ex}E_g\hspace{5ex}\Sigma_{sg}\hspace{5ex}\Sigma_{tg}$

That is, the group number (starting with group "zero," for which the cross sections are zero), the group lower bound, the scattering group cross section, and the total group cross section, separated by spaces.

**Arguments:**

`output_file_base_path` : base of file path of output data files, including base of filename

`material` : name of `G4Material` to calculate cross sections for (must be a named material in `CDMSMaterialTable` in `SuperSim`)

`ngroups` : (optional, default = 100) number of fast groups

`points_per_group` : (optional, default = 10) number of trapezoidal regions to approximate integrals with - note this can only be set if `ngroups` is set




**Example:**

From inside build directory `ntransporter/build`, run

```
./NT_XS ../cross_sections/data/V1/cross_sections G4_Si 100 20
```

The resulting output file will then have the form 

```
<...>/ntransporter/cross_sections/data/V1/cross_sections_G4_Si_100_20_xs.dat
```



### `NT_XX`

`NT_XX` is an expanded version of `NT_XS` that performs calculations for multiple material/group number combinations within a single `SuperSim` instance. 

> [!CAUTION]
> The results of cross section calculations in `Geant4` depend on the order in which values are calculated, meaning that if multiple material/grouping calculations are performed in the same instance of `SuperSim`, as is done by `NT_XX`, the results will change depending on the order of arguments. Use of this executable is not recommended. See [Issue #2](https://github.com/villano-lab/ntransporter/issues/2)

Call signature:

```
./NT_XX output_file_base_path material1 material2 ... [-n ngroups1=100 ngroups2 ...]
```

**Outputs:**

The executable creates output data files for each combination of material/ngroups, i.e., 

```
<output_file_base_path>_<material1>_<ngroups1>_20_xs.dat
<output_file_base_path>_<material1>_<ngroups2>_20_xs.dat
.
.
.
<output_file_base_path>_<material2>_<ngroups1>_20_xs.dat
<output_file_base_path>_<material2>_<ngroups2>_20_xs.dat
.
.
.
```

These files are formatted identically to the `NT_XS` output files.

**Arguments:**

`output_file_base_path` : base of file path of output data files, including base of filename

`material<n>` : names of `G4Material` to calculate cross sections for (must be a named material in `CDMSMaterialTable` in `SuperSim`)

`ngroups<n>` : (optional, default = 100) number of fast groups - note the flag `-n` must be added after the list of materials and before the first of the `ngroup`'s



### `NT_DX`

`NT_DX` uses `Geant4` to estimate the differential cross sections for multiple combinations of material/group number specified at the command line. The call signature is:

```
./NT_DX output_file_base_path path_to_ntransporter_base material1 material2 ... [-n ngroups1=100 ngroups2 ...]
```


**Outputs:**

Similar to `NT_XX`, `NT_DX` will output files for every combination of material/group number specified in the command line arguments. For each combination, the executable creates three files:

1. `<output_file_base>_<material<x>>_<ngroups<y>>_dx.dat`

    The main output file containing differential cross section data, what is eventually used by `NT_BC`. This file contains rows of the form

    $g\hspace{5ex}\Sigma_{sgg}\hspace{5ex}\Sigma_{s,g-1,g}\hspace{5ex}\Sigma_{s,g-2,g}\hspace{5ex}\cdots$

    That is, the group number $g$ (starting at group 1), followed by the self-scattering cross section for group $g$ and then subsequent in-scattering cross sections to group $g$ from the next groups up. Only nonzero contributions are included, and if there are any "gaps" in a column of the cross section matrix $\Sigma_{s}$, all points after the gap are ignored.

2. `<output_file_base>_<material<x>>_<ngroups<y>>_uncers.dat`

    This file contains the relative uncertainty in the cross section estimates due to statistical uncertainty (see the [Evaluating differential cross sections](#evaluating-differential-cross-sections) section below) written row-by-row. The uncertainty is calculated simply as the square root of the number of counts in the bin at the end of the program -- that is, if the number of counts in the bin is $C_{g'g}$, this file contains $1/\sqrt{C_{g'g}}$ in the $g$ column of the $g'$ row.

    This data is not employed anywhere in the core code base of `ntransporter`, but this data can be read into python for analysis with a command such as:

    ```
    uncer_data = np.fromfile(path_to_data + f'{material}_{G}_uncers.dat', sep = ' ', dtype = float).reshape((G+2,G+2))
    ```

    The element `uncer_data[i,j]` is then the uncertainty $1/\sqrt{C_{ij}}$


3. `<output_file_base>_<material<x>>_<ngroups<y>>_alldx.dat`

    Redundancy file containing all differential cross section data, including zero entries. Data is formatted analogously to the `*_uncers.dat` file, with the entries the $\Sigma_{sg'g}$ data.


**Arguments:**


- `output_file_base_path` : base of file path of output data files, including base of filename

- `path_to_ntransporter_base` : path to top-level `ntransporter` directory, e.g., `/home/ajbiffl3/ntransporter`

- `material<n>` : names of `G4Material` to calculate cross sections for (must be a named material in `G4NistManager`; note in this version `SuperSim`-specific materials are not supported)

- `ngroups<n>` : (optional, default = 100) number of fast groups - note the flag `-n` must be added after the list of materials and before the first of the `ngroup`'s

> [!Note]
> In order to run, the file `<path_to_ntransporter_base>/cross_sections/data/V1/data_<material<x>>_<ngroups<y>>_20_xs.dat` must exist for all input material/group number combinations


## Subdirectories

The directory substructure under `cross_sections` is the following:

```
|- ntransporter/
|---- cross_sections/
|------- data/
|---------- V1/
|               output data from NT_XS v1.0
|---------- V2/
|               output data from NT_DX v2.0
|------- examples/
|---------- reading_writing/
|               self-contained example program 
|               to read and print Geant4 cross 
|               section data
```

## Group Cross Section Evaluation

Version 2 of `ntransporter` uses a zeroth-order approximation for the flux in the expressions for the group cross sections:

$\Sigma_{ig} = \frac{1}{\phi_g} \int_g dE \Sigma_i(E) \phi(E)$


$\phi_g = \int_g dE \phi(E)$

where we approximate $\phi(E)$ as a $1/E$ distribution in the fast groups. The group cross sections turn into:


$\Sigma_{ig} = \left(\int_g dE \Sigma_i(E)/E \right)/\left(\int_g dE/E\right)$

We then approximate the integrals as trapezoidal integrals over $n_g$ trapezoids:

$\Sigma_{ig} = \left(\sum\limits_{k=1}^{n_g}\Sigma_i(E_k)/E_k + \Sigma_i(E_{k-1})/E_{k-1}\right)/\left(\sum\limits_{k=1}^{n_g}1/E_k+1/E_{k-1}\right)$

where the $E_k$ are logarithmically spaced between $E_g$ and $E_{g-1}$: $E_k = E_gr^k$, $r=(E_{g-1}/E_g)^{1/n_g}$
 

In the thermal group, the flux is approximated as a Maxwell-Boltzmann distribution 
 $\phi(E)\propto\sqrt{E}e^{-E/kT}$ at room temperature, $kT$ = 0.0257 eV, and is evaluated analogously to the fast groups. 


## Interactions

The evaluated cross sections take data from four hadronic processes in `Geant4`:

- `hadElastic` : elastic scattering
- `neutronInelastic` : inelastic scattering
- `nCapture` : thermal capture, $(n,\gamma)$
- `nFission` : neutron-induced fission

See documentation in the `process_reader` subdirectory for more information on these processes.


Elastic and inelastic cross sections are added together to calculate the scattering cross sections $\Sigma_{sg}$, while all four are added together to calculate the total cross sections $\Sigma_{tg}$.


## Evaluating Differential Cross Sections

The differential cross sections in `NT_DX` are evaluated using Monte Carlo methods with `Geant4`. For each value of $g'$ (initial group) from 1 to $G$, we generate a sample of energies $E_{g'k}$ (indexed by the variable $k$) according to a $1/E$ distribution between $E_{g'}$ and $E_{g'-1}$. 

The `Geant4` method `G4ParticleHPElastic::ApplyYourself` is called on the neutron of each generated energy, which simulates a single elastic scatter and returns the parameters of the neutron post-collision. The final energy $E_{fk}$ is recorded. A matrix of counts is kept, and when the final energy is generated, the entry of the counts matrix $C_{g'g}$ is incremented, where $E_{g}\leq{E_{fk}\leq}E_{g-1}$. 

This procedure is calculated for each initial group $g'$ until the desired statistics are reached. As currently implemented, there are two halting criteria for the simulation. When either one of the following is met, the simulation halts and moves on to the next initial group $g'$:

1. The counts in the group representing the largest energy loss, i.e., the maximum $g$ such that $C_{g'g}>0$, reaches 1,000. This ensures, when the "tail" of the differential cross section does not extend too far (particularly in heavy nuclei), that the statistics in the few groups that *do* involve energy loss will maintain reasonable statistical uncertainty, approx. 3.1%. 

2. The self-scattering count $C_{g'g'}$ reaches $10^5$. This saves a substantial amount of computation time for differential cross sections with long tails, particularly in hydrogenated materials. This ensures that the tail entries, which may take an extremely long time to reach $10^3$ counts and will have much larger relative uncertainties, are guaranteed to be no larger than 1% of the total cross section $\Sigma_{sg'}$.


After all simulation is complete, the elements of the differential cross section matrix $\Sigma_{sg'g}$ are calculated as:

$\Sigma_{sg'g}=\Sigma_{sg'}C_{g'g}/\sum_{g''}C_{g'g''}$

(recall the differential cross section is normalized over final states, thus the summation in the denominator is over the second index).



